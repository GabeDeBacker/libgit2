resources:
- repo: self

trigger:
- master
- maint/*

phases:
- phase: windows_mingw_amd64
  displayName: 'Windows (MinGW; amd64)'
  queue:
    name: Hosted
  steps:
  - task: DownloadBuildArtifacts@0
    displayName: Download Cached Artifacts
    continueOnError: true
    inputs:
      buildType: 'specific'
      buildVersionToDownload: 'latest'
      artifactName: 'mingw-amd64'
      downloadPath: '$(Agent.TempDirectory)\mingw64'
  - powershell: . '$(Build.SourcesDirectory)\ci\setup-mingw.ps1'
    displayName: Setup
    env:
      TEMP: $(Agent.TempDirectory)
      ARCH: amd64
  - powershell: . '$(Build.SourcesDirectory)\ci\build.ps1'
    displayName: Build
    env:
      CMAKE_OPTIONS: -G"MinGW Makefiles"
      PATH: $(Agent.TempDirectory)\mingw64\bin;C:\ProgramData\Oracle\Java\javapath;C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPowerShell\v1.0\;C:\Program Files (x86)\CMake\bin
  - powershell: . '$(Build.SourcesDirectory)\ci\test.ps1'
    displayName: Test
  - task: PublishBuildArtifacts@1
    displayName: Publish Cached Artifacts
    inputs:
      pathToPublish: '$(Agent.TempDirectory)\mingw64'
      artifactName: 'mingw-amd64'

- phase: windows_mingw_x86
  displayName: 'Windows (MinGW; x86)'
  queue:
    name: Hosted
  steps:
  - powershell: . '$(Build.SourcesDirectory)\ci\setup-mingw.ps1'
    displayName: Setup
    env:
      TEMP: $(Agent.TempDirectory)
      ARCH: x86
  - powershell: . '$(Build.SourcesDirectory)\ci\build.ps1'
    displayName: Build
    env:
      CMAKE_OPTIONS: -G"MinGW Makefiles"
      PATH: $(Agent.TempDirectory)\mingw32\bin;C:\ProgramData\Oracle\Java\javapath;C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPowerShell\v1.0\;C:\Program Files (x86)\CMake\bin
  - powershell: . '$(Build.SourcesDirectory)\ci\test.ps1'
    displayName: Test
